name: ğŸ”„ CI/CD WhytMod AI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  ELECTRON_VERSION: '28'

jobs:
  # Tests et validation
  test:
    name: ğŸ§ª Tests & Validation
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ” Lint TypeScript
      run: npm run lint
      
    - name: ğŸ§ª Run tests
      run: npm run test
      
    - name: ğŸ“Š Test coverage
      run: npm run test:coverage
      
    - name: ğŸ›¡ï¸ Security audit
      run: npm run security:audit

  # Build application
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: windows-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build React app
      run: npm run build:renderer
      
    - name: ğŸ—ï¸ Build Electron main
      run: npm run build:main
      
    - name: ğŸ“± Build Electron app
      run: npm run build:electron
      
    - name: ğŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: whytmod-build-${{ github.sha }}
        path: |
          dist/
          !dist/**/*.map
        retention-days: 30

  # Tests sÃ©curitÃ© Electron
  security:
    name: ğŸ›¡ï¸ Security Audit
    runs-on: windows-latest
    needs: build
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: whytmod-build-${{ github.sha }}
        path: dist/
        
    - name: ğŸ” Install security tools
      run: |
        npm install -g @inspect-js/inspectron
        npm install -g electron-security-checker
        
    - name: ğŸ›¡ï¸ Run Inspectron audit
      run: npx inspectron --input ./dist --output ./security-report.json --format json
      
    - name: ğŸ” Run ElectroNG audit
      run: npx electron-security-checker --input ./dist --output ./electrong-report.json
      
    - name: ğŸ“¤ Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports-${{ github.sha }}
        path: |
          security-report.json
          electrong-report.json
        retention-days: 90

  # Release automatique
  release:
    name: ğŸš€ Release
    runs-on: windows-latest
    needs: [test, build, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: whytmod-build-${{ github.sha }}
        path: dist/
        
    - name: ğŸ“¦ Package application
      run: npm run package
      
    - name: ğŸ” Sign application (Windows)
      run: npm run sign:windows
      env:
        WINDOWS_CERT_PASSWORD: ${{ secrets.WINDOWS_CERT_PASSWORD }}
        
    - name: ğŸ“¤ Create release
      run: npm run release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ“Š Upload release metrics
      run: npm run metrics:upload
      env:
        ANALYTICS_KEY: ${{ secrets.ANALYTICS_KEY }}
