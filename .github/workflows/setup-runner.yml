name: ğŸ–¥ï¸ Self-Hosted Runner Setup

on:
  workflow_dispatch:
    inputs:
      runner_name:
        description: 'Nom du runner'
        required: true
        default: 'whytmod-windows-runner'
      runner_labels:
        description: 'Labels du runner (sÃ©parÃ©s par des virgules)'
        required: true
        default: 'windows,whytmod,self-hosted'

jobs:
  setup-runner:
    name: ğŸ”§ Configure Self-Hosted Runner
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ“‹ Display runner information
      run: |
        Write-Host "ğŸ·ï¸ Nom du runner: ${{ github.event.inputs.runner_name }}" -ForegroundColor Green
        Write-Host "ğŸ·ï¸ Labels: ${{ github.event.inputs.runner_labels }}" -ForegroundColor Green
        Write-Host "ğŸ“ Repository: ${{ github.repository }}" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "ğŸ“ Instructions pour configurer le runner:" -ForegroundColor Yellow
        Write-Host "1. TÃ©lÃ©charger le runner depuis: https://github.com/actions/runner/releases" -ForegroundColor White
        Write-Host "2. Extraire dans C:\actions-runner" -ForegroundColor White
        Write-Host "3. ExÃ©cuter la commande de configuration:" -ForegroundColor White
        Write-Host ""
        Write-Host ".\config.cmd --url https://github.com/${{ github.repository }} --token <TOKEN> --name ${{ github.event.inputs.runner_name }} --work _work --labels ${{ github.event.inputs.runner_labels }}" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "4. Installer comme service:" -ForegroundColor White
        Write-Host ".\svc.sh install" -ForegroundColor Cyan
        Write-Host ".\svc.sh start" -ForegroundColor Cyan
      
    - name: ğŸ”— Generate runner registration URL
      run: |
        $repoUrl = "https://github.com/${{ github.repository }}/settings/actions/runners/new"
        Write-Host "ğŸŒ URL de configuration du runner:" -ForegroundColor Green
        Write-Host $repoUrl -ForegroundColor Blue
        
    - name: ğŸ“Š Check existing runners
      run: |
        Write-Host "ğŸ“Š VÃ©rification des runners existants..." -ForegroundColor Yellow
        # Cette Ã©tape sera complÃ©tÃ©e avec l'API GitHub pour lister les runners

  test-runner:
    name: ğŸ§ª Test Runner Connection
    runs-on: self-hosted
    needs: setup-runner
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Verify runner environment
      run: |
        Write-Host "âœ… Runner connectÃ© avec succÃ¨s!" -ForegroundColor Green
        Write-Host "ğŸ–¥ï¸ OS: $env:OS" -ForegroundColor Cyan
        Write-Host "ğŸ·ï¸ Runner: $env:RUNNER_NAME" -ForegroundColor Cyan
        Write-Host "ğŸ“ Workspace: $env:GITHUB_WORKSPACE" -ForegroundColor Cyan
        Get-ComputerInfo | Select-Object WindowsProductName, WindowsVersion, TotalPhysicalMemory
        
    - name: ğŸŸ¢ Test Node.js availability
      run: |
        try {
          $nodeVersion = node --version
          Write-Host "âœ… Node.js version: $nodeVersion" -ForegroundColor Green
        } catch {
          Write-Host "âŒ Node.js non installÃ© sur ce runner" -ForegroundColor Red
        }
        
    - name: ğŸ”§ Test Git availability
      run: |
        try {
          $gitVersion = git --version
          Write-Host "âœ… Git version: $gitVersion" -ForegroundColor Green
        } catch {
          Write-Host "âŒ Git non installÃ© sur ce runner" -ForegroundColor Red
        }
        
    - name: ğŸ“Š Runner performance test
      run: |
        Write-Host "ğŸš€ Test de performance du runner..." -ForegroundColor Yellow
        $start = Get-Date
        1..1000 | ForEach-Object { $_ * 2 }
        $end = Get-Date
        $duration = ($end - $start).TotalMilliseconds
        Write-Host "â±ï¸ Test terminÃ© en $duration ms" -ForegroundColor Green
